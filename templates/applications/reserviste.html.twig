{% extends "base.html.twig" %}

{% block title %} {{ title }}  {% endblock %}

{% block body %}
<style >
{% if isCandidated %}
    #dt-candidatures tbody tr.selected {
      background-color: #1ABC9C !important;
    } 
{% else %}
    #dt-candidatures tbody tr.selected {
      background-color: #f54242 !important;
    } 
{% endif %}
</style>


<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-12">  
                            {% if isCandidated %}
                                {% if app.request.get('_route') == 'app_candidats_lga'  and  app.request.get('id') is not null %}
                                    
                                    
                                            <div class="col-md-12">
                                                <fieldset class="border p-2">
                                                    <legend>
                                                        <h6>
                                                            <p>ALL THE LGA</p> 
                                                        </h6>
                                                    </legend>
                                                    <a class='btn btn-primary btn-sm waves-effect waves-light btn-sm' 
                                                        title="Click pour télécharger la liste des candidats"
                                                        target="_blank" href="{{ path( 'app_export_candidats_cacr_zip', {'id':app.request.get('id') })}}"> 
                                                        Download the list of all applicants <i  style="font-size:16px;margin-left: 30%; cursor:pointer " class="ti-download"></i>
                                                    </a> &nbsp;                                                

                                                    <div class="dropdown-inverse dropdown open">
                                                        <button class="btn btn-primary dropdown-toggle waves-effect waves-light btn-sm" type="button" id="dropdown-7" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Download files</button>
                                                        <div class="dropdown-menu" aria-labelledby="dropdown-7" data-dropdown-in="fadeIn" data-dropdown-out="fadeOut">
                                                            <a target="_blank" class="dropdown-item waves-light waves-effect" href="{{ path( 'get_pieces_jointes_candidat_per_departement', {'id':app.request.get('id') })}}">of LGA {{lga.name}} </a>
                                                            <a class="dropdown-item waves-light waves-effect" href="javascript:void(0)"  onclick="$('#scoreSelection').modal('show');"  >of Candidates by Score</a>
                                                        </div>
                                                    </div>
                                                </fieldset>
                                            </div>
                                            <div class="col-md-12 pt-2">
                                                <fieldset class="border p-2">
                                                    <legend>
                                                        <h6>
                                                            <p>BY DISTRICT</p>
                                                        </h6>
                                                    </legend>
                                                    <form class="form-inline">
                                                        <div class="form-group">
                                                            <select class="form-control" id="cacr">
                                                                <option value=""></option>
                                                                {% for c in communes %}
                                                                    <option value="{{ c.id }}">{{ c.nom }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>

                                                        <div class="form-group">
                                                            &nbsp;&nbsp;
                                                            <button class="btn btn-sm btn-primary" 
                                                                    type="button" 
                                                                    id="downloadModel">
                                                                Exporter postulants de la Commune
                                                        </div> &nbsp;&nbsp;
                                                        <div class="dropdown-inverse dropdown open" id="folderDiv">
                                                            <button class="btn btn-primary dropdown-toggle waves-effect waves-light btn-sm " type="button" id="dropdown-7" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Télécharger les Dossiers</button>
                                                            <div class="dropdown-menu" aria-labelledby="dropdown-7" data-dropdown-in="fadeIn" data-dropdown-out="fadeOut">
                                                                <a target="_blank" class="dropdown-item waves-light waves-effect" href="javascript:void(0)" id="per_cacr"></a>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </fieldset>
                                            </div>
                                       

                                {% endif %} 

                                {% if app.request.get('_route') == 'app_candidats_regions'  and  app.request.get('id') is not null %}
                                    <a class='btn btn-success btn-xs waves-effect waves-light' 
                                        title="Click pour télécharger la liste des candidats"
                                        target="_blank" href="{{ path( 'app_candidats_region_export', {'id':app.request.get('id') })}}"> 
                                        Download the list of all applicants <i  style="font-size:16px;margin-left: 30%; cursor:pointer " class="ti-download"></i>
                                    </a>  
                                {% endif %} 

                                {% if app.request.get('_route') == 'app_candidats_atics'%}
                                    <a class='btn btn-success btn-xs waves-effect waves-light' 
                                        title="Click pour télécharger la liste des candidats"
                                        target="_blank" href="{{ path( 'app_candidats_atics_export')}}"> 
                                        Download the list of all applicants <i  style="font-size:16px;margin-left: 30%; cursor:pointer " class="ti-download"></i>
                                    </a>  
                                {% endif %} 
                                                            
                            {% endif %}
                            {% if app.request.get('_route') == 'app_candidats_departement_formation'  and  app.request.get('id') is not null %}
                                

                                <div class="form-inline">
                                    {% if not is_granted("ROLE_SRSD") %}
                                    {% endif %}
                                    {% if is_granted("ROLE_SRSD") %}
                                    <div class="form-group">
                                        <label for="dept">DEPARTEMENT</label> &nbsp;
                                        <select class="form-control" id="dept">
                                            {% for dept in departments %}
                                                <option value="{{ dept.id }}">{{ dept.nom }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>&nbsp;&nbsp;
                                    {% endif %}
                                    <div class="dropdown-primary dropdown open">
                                        <button class="btn btn-primary dropdown-toggle waves-effect waves-light " type="button" id="dropdown-2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Exporter</button>
                                        <div class="dropdown-menu" aria-labelledby="dropdown-2" data-dropdown-in="fadeIn" data-dropdown-out="fadeOut">
                                            {# <a class="dropdown-item waves-light waves-effect myUrl" target="_blank" href="{{ path( 'app_selectionner_departement_export', {'id':app.request.get('id') })}}" >Liste des Candidats</a>
                                            <a class="dropdown-item waves-light waves-effect myUrl" target="_blank" href="{{ path( 'app_procesverbal_departement_export', {'id':app.request.get('id') })}}">Proces Verbal</a> #}
                                            <a class="dropdown-item waves-light waves-effect myUrl" data-id='excel' href="javascript:void();" >Liste des Candidats</a>
                                            <a class="dropdown-item waves-light waves-effect myUrl" data-id='pdf' href="javascript:void();">Proces Verbal</a>
                                        </div>
                                    </div>
                                </div>


                                
                            {% endif %} 
                            {% if app.request.get('_route') == 'app_candidats_atics_formation'%}
                                  {#   <a class='btn btn-success btn-xs waves-effect waves-light' 
                                        title="Click pour télécharger la liste des candidats"
                                        target="_blank" href="{{ path( 'app_selectionner_atics_export')}}"> 
                                        Exporter cette liste <i  style="font-size:16px;margin-left: 30%; cursor:pointer " class="ti-download"></i>
                                    </a>   #}

                                    <div class="dropdown-primary dropdown open">
                                        <button class="btn btn-primary dropdown-toggle waves-effect waves-light " type="button" id="dropdown-3" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Exporter</button>
                                        <div class="dropdown-menu" aria-labelledby="dropdown-2" data-dropdown-in="fadeIn" data-dropdown-out="fadeOut">
                                            <a class="dropdown-item waves-light waves-effect" target="_blank" href="{{ path( 'app_selectionner_atics_export')}}" >Liste des Candidats</a>
                                            <a class="dropdown-item waves-light waves-effect" target="_blank" href="{{ path( 'app_procesverbal_atics_export')}}">Proces Verbal</a>
                                        </div>
                                    </div>
                                {% endif %} 
                       
                    </div>
                </div>
            </div>
            <div class="card-block">
                
                {% for label, messages in app.flashes %}
                    <div class="alert bg-{{ label }} text-center" style="height: 50px">
                        {% for message in messages %}
                            <p>{{ message | raw }}</p>
                        {% endfor %}
                    </div>
                {% endfor %}

                <div class="table-responsive dt-responsive">
                    
                    <table id="dt-candidatures" class="table table-striped table-bordered nowrap" >
                        <thead>
                            <tr>  
                                {# <th scope="col">Edit  
                                </th>                                   #}
                                <th scope="col">Score  
                                </th>
                                <th>Depuis</th>
                                <th scope="col">Numero Dossier</th>
                                {# <th scope="col">Est affecté(e) ?</th> #}
                                {# <th scope="col">Poste</th> #}
                                <th scope="col">NIN</th>
                                <th scope="col">Prénom</th>
                                <th scope="col">Nom</th>
                                <th scope="col">Région</th>
                                <th scope="col">Département</th>
                                <th scope="col">CAV</th>
                                <th scope="col">Commune</th>
                                <th scope="col">Téléphone</th>
                                {# <th scope="col">Email</th> #}
                                <th scope="col">Date Naissance</th>
                                <th scope="col">Dérniere Diplome</th>
                                {# <th scope="col">Derniere  Classe</th> #}
                                <th scope="col" title="Connaissance en informatique">Informatique</th>
                                <th scope="col"  title="Exprerience en enquetes">Enquetes</th>
                                <th scope="col">Recensements</th>
                                <th scope="col">Enquetes Digitales</th>
                                <th scope="col">Dossier</th>
                                <th scope="col">candidat</th>
                                {% if is_granted("ROLE_COORDINATION") %}
                                    <th scope="col">Reaffecter</th>
                                {% endif %}
                                

                            </tr>
                            <tr>
                                {# <th scope="col"></th> #}
                                <th scope="col">Score</th>
                                <th scope="col"></th>
                                <th scope="col">Numero Dossier</th>
                                {# <th scope="col">isAffected</th> #}
                                {# <th scope="col">Poste</th> #}
                                <th scope="col">Nin</th>
                                <th scope="col">Prénom</th>
                                <th scope="col">Nom</th>
                                <th scope="col">Région</th>
                                <th scope="col">Département</th>
                                <th scope="col">CAV</th>
                                <th scope="col">CACR</th>
                                <th scope="col">Téléphone</th>
                                {# <th scope="col">Email</th> #}
                                <th scope="col"></th>
                                <th scope="col">Dérniere Diplome</th>
                                {# <th scope="col">Derniere  Classe</th> #}
                                <th scope="col">Informatique</th>
                                <th scope="col">Enquetes</th>
                                <th scope="col">Recensements</th>
                                <th scope="col">Enquetes Digitales</th>
                                <th scope="col">Dossier</th>
                                <th scope="col">Candidat</th>
                                {% if is_granted("ROLE_COORDINATION") %}
                                <th scope="col"></th>
                            {% endif %}
                            </tr>
                        </thead>
                    </table>
                </div>                        
            </div>
        </div>
       {% if is_granted("ROLE_COORDINATION")  %}
       <div class="card">
        <div class="card-header">
            <h5>Reaffecter dans une autre Commune</h5>
        </div>
        <div class="card-block">
            

            <div class="table-responsive dt-responsive">
               
                <table id="dt_candidatures_reaffectation" class="table table-striped table-bordered nowrap" >
                    <thead>
                        <tr>  
                            <th scope="col">Score</th>
                            <th scope="col"></th>
                            <th scope="col">Numero Dossier</th>
                            <th scope="col">Poste</th>
                            <th scope="col">Nin</th>
                            <th scope="col">Prénom</th>
                            <th scope="col">Nom</th>
                            <th scope="col">Région</th>
                            <th scope="col">Département</th>
                            <th scope="col">CAV</th>
                            <th scope="col">Commune</th>
                            <th scope="col">Supprimer</th>

                        </tr>
                        
                    </thead>
                </table>
            </div>  

            <form class="form-inline"  method="POST"  action="{{path('reaffectationCandidatsCommune')}}" id="reaffectationCandidatsCommune">
                <div class="form-row">
                    <div class="form-group mb-2">
                        <label >Département</label>
                        <select  class="form-control" name="departement" id="departementReaffectation" required>
                        </select>
                    </div>
                    <div class="form-group mx-sm-3 mb-2 ">
                        <label>Commune</label>
                        <select class="form-control" name="commune"  id="communeReaffectation"  required >
                        </select>
                    </div>
                    <select name="candidats[]" multiple style="display: none;">
                        <option value="">Choisir un </option>
                    </select>
                    <div class="form-group mx-sm-3 mb-2 ">
                        <button type="submit" class="btn btn-primary mb-2" style="margin-top: 20px;" >Réaffecter</button>
                    </div>
                </div>
                
                
            </form>

        </div>
    </div>
       {% endif %}
    </div>
</div>

<div class="modal fade" tabindex="-1" id="scoreSelection">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Exportation de Dossier des candidats ayant les score </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
           <div class="modal-body">
            <form action="" id="selectionScore">
                <div class="form-group  row">
                    <div class="col-sm-2">
                        <label class="col-form-label" for="de">De</label>
                    </div>
                    <div class="col-sm-4">
                        <select  class="form-control" id="de"  name="de" onchange="updateLinkDossierScore()" >
                            <option value="10">0</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="30">30</option>
                            <option value="40">40</option>
                            <option value="50">50</option>
                            <option value="60">60</option>
                            <option value="70">70</option>
                            <option value="80">80</option>
                            <option value="90">90</option>
                            <option disabled value="100">100</option>
                        </select>
                    </div>
               
                    <div class="col-sm-2">
                        <label class="col-form-label" for="a">A</label>
                    </div>
                    <div class="col-sm-4">
                        <select type="text" class="form-control" id="a"  name="a" onchange="updateLinkDossierScore()">
                            <option  disabled value="10">10</option>
                            <option value="20">20</option>
                            <option value="30">30</option>
                            <option value="40">40</option>
                            <option value="50">50</option>
                            <option value="60">60</option>
                            <option value="70">70</option>
                            <option value="80">80</option>
                            <option value="90">90</option>
                            <option value="100" selected >100</option>
                        </select>
                    </div>
                </div>
        </form>
           </div>
            <div class="modal-footer">
                <a  class="btn btn-primary btn-sm" target="_blank"   href="{{ path('get_pieces_jointes_candidat_per_score' , {'id':  departement is defined ? departement.id : 0 , 'de': 0 , 'a':100 }  ) }}"  >Exporter</a>
                <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">Fermer</button>
            </div>
           
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}
    {{ parent() }}

    <script>
        var usersDt;
        var regionCode;
        var dtCandidaturesReaffectation
                
        $(document).ready(function(){
            var is_com_recrutement = '{{ iscom }}' == 1 ? true : false;

            $("#selectMultipleClass").hide();

            $('#dt-candidatures thead tr:nth-child(2) th').each( function () {
                var title = $(this).text();
                if (title){
                    if (title == "isAffected") {
                        $(this).html( `<select  class="form-control form-control-xs" size="height:none">
                                            <option></option>
                                            <option value="1">Affecté(e) à un superviseur</option>
                                            <option value="0">Non affecté(e)</option>
                                        </select>    
                        `);
                    } else {
                        $(this).html( '<input type="text" class="form-control form-control-xs" style="width:90%" placeholder="Recherche '+title+'" />' );
                    }
                }
            });

            usersDt = $('#dt-candidatures').DataTable({
                select: true,
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.11.3/i18n/fr_fr.json'
                },
                "serverSide": true,
                "processing": true,    
                "ajax": "{{app.request.attributes.get('_route_params') | length > 0 ?  path(app.request.attributes.get('_route'),app.request.attributes.get('_route_params')) :  path(app.request.attributes.get('_route'))  }}",
                "paging": true,
                "pageLength": 50,
                "lengthMenu": [ 10,20, 25, 50, 100],
                "order": [[ 1, 'desc' ]],
                "columns": [
                       
                        { "data": "score", "orderable": true },
                        {"data": "createdAt"},
                        {"data": "numeroDossier"},
                        { "data": "nin"},
                        { "data": "prenom" },
                        { "data": "nom" },
                        {"data": "region.nom",'default': ''},
                        {"data": "departement.nom",'default': ''},
                        {"data": "cav.nom",'default': '','render': function(data,type,row) { return row.cav == null ? '':row.cav.nom;  }      },
                        {"data": "cacr.nom",'default': ''},
                        {"data": "telephone"},
                        //{"data": "email"},
                        {"data": "dateNaissance"},
                        {"data": "diplome"},
                        //{"data": "classe"},
                        {'data': 'informatique', 'render': function(data,type,row){
                                            return row.informatique?`<i  style="color:green;font-size:16px;margin-left: 30%;" class="ti-check"></i>`: `<i style="color:red;font-size:16px;margin-left: 30%;" class="ti-na"></i>`; 
                                    }
                        },
                        {'data': 'enquetes', 'render': function(data,type,row){
                            return row.enquetes?`<i  style="color:green;font-size:16px;margin-left: 30%;" class="ti-check"></i>`: `<i style="color:red;font-size:16px;margin-left: 30%;" class="ti-na"></i>`; 
                             }
                        },
                        {'data': 'recensement', 'render': function(data,type,row){
                            return row.recensement?`<i  style="color:green;font-size:16px;margin-left: 30%;" class="ti-check"></i>`: `<i style="color:red;font-size:16px;margin-left: 30%;" class="ti-na"></i>`; 
                             }
                        },
                        {'data': 'enquetedigital', 'render': function(data,type,row){
                            return row.enquetedigital?`<i  style="color:green;font-size:16px;margin-left: 30%;" class="ti-check"></i>`: `<i style="color:red;font-size:16px;margin-left: 30%;" class="ti-na"></i>`; 
                             }
                        },
                        {'default': '', 'render': function(data,type,row){
                            return ` <a target="_blank"  class='btn btn-default btn-xs waves-effect waves-light' href="${Routing.generate('get_pieces_jointes_candidat', {'numeroDossier':row.numeroDossier })}">  <i  style="font-size:16px;margin-left: 30%; cursor:pointer " class="ti-archive"></i></a>`; 
                             }
                        },

                        {'default': '', 'render': function(data,type,row){
                            var url = Routing.generate('app_Candidats_detail', { id: row.id });
                            return ` <a   class='btn btn-default btn-xs waves-effect waves-light' href="${url}">  <i  style="font-size:16px;margin-left: 30%; cursor:pointer " class="ti-id-badge"></i></a>`; 
                             }
                        }
                        {% if is_granted("ROLE_COORDINATION")  %}
                        ,
                        {'default': '', 'render': function(data,type,row){
                            return ` <a   class='btn btn-default btn-xs waves-effect waves-light'  onclick="ajouterCandidatReaffectation(${row.id})"  >  <i  style="font-size:16px;margin-left: 30%; cursor:pointer " class="ti-reload"></i></a>`; 
                             }
                        }
                        {% endif %}
                        
                        
                    ],
                    initComplete: function () {
                        // Apply the search
                        this.api().columns().every( function () {
                            var that = this;
                            $( 'input', this.header() ).on( 'keyup change clear', function (e) {
                                    alert( this.value )
                                if (e.keyCode == 13 && that.search() !== this.value ) {
                                    that
                                        .search( this.value )
                                        .draw();
                                }
                            });

                            $('select', this.header() ).on( 'change', function (e) {
                                if (that.search() !== this.value ) {
                                    that
                                        .search( this.value )
                                        .draw();
                                }
                            });

                        });
                    },
                    drawCallback: function(settings){
                        
                    }        
            });

            $('#dt-candidatures tbody').on( 'click', 'tr', function () {
                /*let is_candidated = '{{isCandidated}}';                
                //if (!is_candidated) return;

                if (!is_com_recrutement){
                    $('#dt-candidatures > tbody > tr').removeClass("selected");
                    $("#selectMultipleClass").hide();
                    return;
                }

                $(this).toggleClass('selected');
                console.log(usersDt.rows('.selected').data());
                if(usersDt.rows('.selected').data().length){
                    $("#selectMultipleClass").show();                    
                }else {
                    $("#selectMultipleClass").hide();
                }*/
            });

            $('#selectMultipleClass').click(function(){
                var candidatsElus =  [];
                let is_candidated = '{{isCandidated}}';
                let verbe = is_candidated ? "retenir" : "retirer";
                let callback_title = is_candidated ? "Sélection Réussie" : "Annulation de sélection réussie";

                for(var i=0 ; i < usersDt.rows('.selected').data().length ;  i++){
                    candidatsElus.push(usersDt.rows('.selected').data()[i]['numeroDossier']) ;
                }
                if(candidatsElus == null || candidatsElus.length ==0){
                    return ;
                }

                console.log(candidatsElus);

                var selectedAction =  function(){
                    return new Promise(function(resolve,reject){
                        $.ajax({
                            type: "GET",
                            url: "{{ path('app_candidats_departement_selected') }}",
                            data: {
                                numeros: candidatsElus,
                                'iscandidated': is_candidated
                            },
                            beforeSend: function(){
                               $('.pigor-loader').show();
                            },
                            success: function (response) {
                               $('.pigor-loader').hide();
                               resolve();
                               usersDt.ajax.reload(); 
                            },
                            error: function (response) {
                                $('.pigor-loader').hide();
                                reject();
                            }
                        })
                    });
                };
                confirmationToExecutePromise('Etes-vous sûre de vouloir '+verbe+' ces candidats sélectionnés pour la formation des AR ','Sélection AR', callback_title, selectedAction).then(function(){
                    usersDt.ajax.reload(); 
                    $("#selectMultipleClass").hide();
                });
            });

            // remplissage du formulaire de modification
            $(document).on ("click", ".edit-button-class", function (){
                // désactive la coloration de ligne
                $('#dt-candidatures > tbody > tr').removeClass("selected");
                $("#selectMultipleClass").hide();
                

                let id = $(this).data('id');
                if(!id) {
                    $('#editeSU').modal('toggle');
                    $('#editeSU').modal('hide');

                    return;
                }
                let email = $(this).data('email');
                let prenom = $(this).data('prenom');
                let nom = $(this).data('nom');
                let telephone = $(this).data('tel');
                let adresse = $(this).data('adresse');
                let nin = $(this).data('cni');

                let datenaiss = $(this).data('datenaiss');
                let lieunaiss = $(this).data('lieunaiss');

                $('#idSu').val(id);
                $('#prenomMaj').val(prenom);
                $('#nomMaj').val(nom);
                $('#telephoneMaj').val(telephone);
                $('#adresseMaj').val(adresse);
                $('#emailMaj').val(email);
                $('#cniMaj').val(nin);

                var dt = new Date(datenaiss).toISOString().split('T')[0];

                $('#dateMaj').val(dt);
                $('#lieuMaj').val(lieunaiss);

                $('#editeSU').modal('toggle');
                $('#editeSU').modal('show');
            });

            // faire la mise à jour du candidat
            $('#formUpdate').submit(function(e){

                //prevent default
                e.preventDefault();

                //do something here
                $("#btn-update-agent").attr("disabled", "disabled");

                $.ajax({
                    type: "POST",
                    url: "{{ path('candidat_update') }}",
                    data: { 
                        '_id': $("#idSu").val(),
                        '_prenom': $("#prenomMaj").val(), 
                        '_nom':    $("#nomMaj").val(), 
                        '_telephone': $("#telephoneMaj").val(), 
                        '_adresse': $("#adresseMaj").val(), 
                        '_email': $("#emailMaj").val(),
                        '_cni': $("#cniMaj").val(),

                        '_datenaiss': $("#dateMaj").val(),
                        '_lieunaiss': $("#lieuMaj").val(),
                    },
                    success: function (response) { 
                        $('#editeSU').modal('toggle');
                        $('#editeSU').modal('hide');   
                        $("#selectMultipleClass").hide();
                        usersDt.ajax.reload();                    
                        $("#btn-update-agent").removeAttr("disabled");
                    },
                    error: function (response) {
                        $("#selectMultipleClass").hide();
                        $('#editeSU').modal('toggle');
                        $('#editeSU').modal('hide');  
                        $("#btn-update-agent").removeAttr("disabled");
                    }
                })
                //continue submitting
                return;
                e.currentTarget.submit();

            });

            // edition du cni avec test d'existence
            $('#cniMaj').keyup(function(){
                let cni = $(this).val();

                if(cni){
                    $.ajax({
                        url: "{{ path('app_candidats_cni_checks') }}",
                        data: {cni: cni},
                        method: 'GET',
                        dataType: 'json',
                        success: function (isExist) {
                            console.log("is Exists "+isExist)
                            //var isExist = cnis > 1 ? true : false;

                            if(isExist) {
                                $('#cniMaj').css({"color":"red"});
                                $('#btn-update-agent').prop('disabled', true);
                                $("#cniError").html("Ce CNI existe déjà !")
                                $('#cniError').css('color', 'red');
                            } else if (!isExist && (cni.toString().length == 13 || cni.toString().length == 14)) {
                                $('#cniMaj').css({"color":"green"});
                                $('#btn-update-agent').prop('disabled', false);
                                $("#cniError").html("");
                            }  else if(!isExist && (cni.toString().length <=12 || cni.toString().length >= 14)) {
                                $('#cniMaj').css({"color":"red"});
                                $('#btn-update-agent').prop('disabled', true);
                                $("#cniError").html("Le CNI doit comporter 13 ou 14 chiffres !")
                                $('#cniError').css('color', 'red');
                            }
                        }, error: function (status, code) {
                            
                        }
                    });
                }
            });

            $('.myUrl').click(function(){
                let label =  $(this).data("id");
                let id = $("#dept").val();
                // si c'est un profile CTD/CTR
                if(id == undefined) {
                    id = "{{ app.user.departement.id }}";
                }

                let pdf_url2 = "";
                if (label == "excel") {
                    pdf_url2 = Routing.generate('app_selectionner_departement_export', {id: id})
                } else {
                    pdf_url2 = Routing.generate('app_procesverbal_departement_export', {id: id})
                }    
                //console.log(pdf_url2)            
                window.open(`${pdf_url2}`, '_blank');
            });


            {% if is_granted("ROLE_COORDINATION")  %}
            dtCandidaturesReaffectation = $("#dt_candidatures_reaffectation").DataTable({
                data: [],
                rowId: 'id',
                columns: [
                    {'data': 'score'},
                    {'data': 'createdAt'},
                    {'data': 'numeroDossier'},
                    {'data': 'posteSouhaite'},
                    {'data': 'nin'},
                    {'data': 'prenom'},
                    {'data': 'nom'},
                    {"data": "region.nom",'default': ''},
                    {"data": "departement.nom",'default': ''},
                    {"data": "cav.nom",'default': '','render': function(data,type,row) { return row.cav == null ? '':row.cav.nom;  }      },
                    {"data": "cacr.nom",'default': ''},
                    {'default': '', 'render': function(data,type,row){
                        return ` <a   class='btn btn-default btn-xs waves-effect waves-light'  onclick="supprimerCandidatReaffectation(${row.id})"  >  <i  style="font-size:16px;margin-left: 30%; cursor:pointer " class="ti-trash"></i></a>`; 
                         }
                    }
                ]
            });
            {% endif %}
           

          
            
            $('#departementReaffectation').select2({
                    placeholder: "Choisir Départemement",
                    delay: 100,
                    ajax: {
                    url: "{{ url('app_departements') }}",
                    dataType: 'json',
                    data: function (params) {
                        var query = {
                        term: params.term,
                        };
                        // Query parameters will be ?search=[term]&type=public
                        return query;
                    },
                    processResults: function (regions) {
                        return {
                        results: regions.map(function(region) { var r = { id:region.code , text:`${region.nom}: ${region.code}`}; return r}),
                        total: regions.length
                        };
                    }
                    }
                    });

                    $('#communeReaffectation').select2({
                        placeholder: "Choisir La nouvelle Commune",
                        delay: 100,
                        ajax: {
                        url: function(params){
                            console.log(params);
                            return `{{ url('app_cacr') }}?regionCode=${regionCode ? regionCode : ''}`;
                        },
                        dataType: 'json',
                        data: function (params) {
                            var query = {
                            term: params.term,
                            };
                            // Query parameters will be ?search=[term]&type=public
                            return query;
                        },
                        processResults: function (regions) {
                            return {
                            results: regions.map(function(region) { var r = { id:region.id , text:`${region.nom}: ${region.code}`}; return r}),
                            total: regions.length
                            };
                        }
                        }
                        });
                        $('#departementReaffectation').on('select2:select', function (e) {
                            var data = e.params.data;
                            console.log(data);
                            regionCode = data.id;
                        });

        });

        $(document).ready(function(){
            $('.dropdown-toggle').dropdown()
        });

        function updateLinkDossierScore() {
            var de = $("#selectionScore #de").val();
            var a = $("#selectionScore #a").val();
            $("#scoreSelection a.btn.btn-primary.btn-sm").attr("href",Routing.generate('get_pieces_jointes_candidat_per_score', { 'de': de , 'a': a , 'id': {{ departement is defined ?  departement.id : 0 }}   })  );
        }
        function ajouterCandidatReaffectation(idCandidat){
            var candidat  =  usersDt.rows().data().filter( function(row) { return row.id == idCandidat})[0] ; 
            console.log(candidat);
            
            if(dtCandidaturesReaffectation.rows().data().filter( function(row) { return row.id == idCandidat}).length == 0 ){
                 dtCandidaturesReaffectation.rows.add([candidat]).draw();
            }
           
            $("#reaffectationCandidatsCommune select[name='candidats[]'] ").append(`<option value='${idCandidat}' selected  >${candidat.numeroDossier}</option>`);
        }
        function supprimerCandidatReaffectation(idCandidat){
            var  candidat =  dtCandidaturesReaffectation.rows().data().filter( function(row) { return row.id == idCandidat})[0] ; 
            console.log(candidat);
            dtCandidaturesReaffectation.row(`#${idCandidat}`).remove().draw();
            $(`#reaffectationCandidatsCommune select[name='candidats[]']>option[value='${idCandidat}']`).remove();

        }

        $("#downloadModel").hide();
        $("#folderDiv").hide();

        $("#cacr").change(function(){
            let ccrca =   $("#cacr option:selected").text();
            if ($(this).val() != "") {
                $("#downloadModel").show();
                $("#folderDiv").show();
                $("#per_cacr").html(`des Candidats de ${ccrca}`);
                $("#per_cacr_score").html(`des Candidats par score ${ccrca}`);
            } else {
                $("#downloadModel").hide();
                $("#folderDiv").hide();
            }
        });

        $('#downloadModel').click(function(){
            let cacr =  $("#cacr").val();
            if (cacr == "") {                    
                Swal.fire(
                    'Attention !',
                    'Sélectionnez dabord une Commune.',
                    'warning'
                );
                return;
            }

            let export_cacr_url = Routing.generate('app_candidats_cacr_export', {id: cacr })
            window.open(`${export_cacr_url}`, '_blank');
        });

        $('#per_cacr').click(function(){
            let cacr =  $("#cacr").val();
            if (cacr == "") {                    
                Swal.fire(
                    'Attention !',
                    'Sélectionnez dabord une Commune.',
                    'warning'
                );
                return;
            }

            let export_cacr_url = Routing.generate('get_pieces_jointes_candidat_per_commune', {id: cacr })
            window.open(`${export_cacr_url}`, '_blank');
        });

{#
        function displayEditCandidat(idCandidat) {
            candidat =  usersDt.rows().data().filter( function(row) { return row.id == idCandidat})[0] ;            
            console.log(candidat);

            Object.keys(candidat).forEach(function(proper){
                $(`#editeSU input[name='${proper}']`).val(candidat[proper]) ;
            });

            $("#editeSU .modal-title").html(`Reaffecter le candidat ${candidat.numeroDossier} dans  un autre département`)

        $('#region').select2({
            dropdownParent: $('#editeSU'),
           placeholder: "Choisir une région",
        });
            
            $('#editeSU').modal('show');
        }

        function generationCsdbCandidat(event){
            event.preventDefault();
            var generatedCsdb =  function(){
                return new Promise(function(resolve,reject){
                    $.ajax({
                        type: "POST",
                        url: "{{ path('generate_csdb_candidat_by_departement', { 'departement':  app.request.get('id') }) }}",
                        data: {},
                        beforeSend: function(){
                            $('.pigor-loader').show();
                        },
                        success: function (response) {
                           $('.pigor-loader').hide();
                           resolve();
                           Swal.fire(
                                'Creation!',
                                'Génération de Fichiers CSDB a reussi !.',
                                'success'
                            );
                        },
                        error: function (response) {
                            reject(response);
                            Swal.fire(
                                'Creation!',
                                'Génération de Fichiers CSDB a échoué !.',
                                'error'
                            );
                            $('.pigor-loader').hide();
                        }
                    })
                });
            };
            confirmationToExecutePromise('de vouloir initialiser le Mobile du Superviseur; il va prendre en compte que la liste des candidats ayants confirmés','Initialisation Mobile', 'Initialisation Mobile Réussie', generatedCsdb).then(function(){
                document.location.href = '';
            }, function(error){
                console.error(error)
            });
        }
        #}

    </script>
{% endblock %}

